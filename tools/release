#!/usr/bin/env bash
set -euo pipefail

VERSION="${1:?Usage: tools/release <version>  (e.g. 0.2.0)}"

# Cargo.toml のバージョンを更新
sed -i '' "s/^version = \".*\"/version = \"${VERSION}\"/" Cargo.toml

# Cargo.lock を更新
cargo check --quiet 2>/dev/null || true

# 変更があればコミット＆プッシュ
if ! git diff --quiet Cargo.toml Cargo.lock 2>/dev/null; then
  git add Cargo.toml Cargo.lock
  git commit -m "v${VERSION}"
  git push
else
  echo "バージョンは既に ${VERSION} です。コミットをスキップ。"
  # 未プッシュのコミットがあればプッシュ
  if [ "$(git rev-list --count @{u}..HEAD 2>/dev/null)" -gt 0 ]; then
    git push
  fi
fi

# GitHub Actions の release ワークフローをトリガー
gh workflow run release.yaml -f version="v${VERSION}"

echo ""
echo "=== v${VERSION} リリース開始 ==="
echo "進捗確認: gh run watch"
