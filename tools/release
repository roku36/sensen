#!/usr/bin/env bash
set -euo pipefail

VERSION="${1:?Usage: tools/release <version>  (e.g. 0.2.0)}"

# Cargo.toml のバージョンを更新
sed -i '' "s/^version = \".*\"/version = \"${VERSION}\"/" Cargo.toml

# Cargo.lock を更新
cargo check --quiet 2>/dev/null || true

# 変更があればコミット＆プッシュ
if ! git diff --quiet Cargo.toml Cargo.lock 2>/dev/null; then
  git add Cargo.toml Cargo.lock
  git commit -m "v${VERSION}"
  git push
else
  echo "バージョンは既に ${VERSION} です。コミットをスキップ。"
  if [ "$(git rev-list --count @{u}..HEAD 2>/dev/null)" -gt 0 ]; then
    git push
  fi
fi

# GitHub Actions の release ワークフローをトリガー
gh workflow run release.yaml -f version="v${VERSION}"

PAGES_URL="$(gh repo view --json owner,name -q '(.owner.login) + ".github.io/" + .name' 2>/dev/null || echo 'roku36.github.io/sensen')"

echo ""
echo "=== v${VERSION} リリース開始 ==="
echo "進捗確認: gh run watch"
echo ""
echo "デプロイ先:"
echo "  最新版:     https://${PAGES_URL}/latest/"
echo "  v${VERSION}: https://${PAGES_URL}/v${VERSION}/"
echo "  一覧:       https://${PAGES_URL}/"
