name: Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Version (e.g. v0.2.0)"
        required: true
        type: string

concurrency:
  group: release
  cancel-in-progress: false

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@nightly
        with:
          targets: wasm32-unknown-unknown

      - name: Install cargo-binstall
        uses: cargo-bins/cargo-binstall@main

      - name: Install Bevy CLI
        run: cargo binstall --version 0.1.0-alpha.2 --locked --no-confirm --force --git='https://github.com/TheBevyFlock/bevy_cli' bevy_cli

      - name: Build web bundle
        run: |
          cargo binstall --locked --no-confirm --force wasm-bindgen-cli
          cargo binstall --locked --no-confirm --force wasm-opt
          bevy build --locked --release --yes web --bundle

      - name: Save build output
        run: cp -r target/bevy_web/web-release/sensen /tmp/web-bundle

      - name: Checkout gh-pages branch
        run: |
          git fetch origin gh-pages:gh-pages 2>/dev/null || true
          if git rev-parse --verify gh-pages >/dev/null 2>&1; then
            git checkout gh-pages
          else
            git checkout --orphan gh-pages
            git rm -rf .
            git commit --allow-empty -m "init gh-pages"
          fi

      - name: Deploy versioned build
        env:
          VERSION: ${{ inputs.version }}
        run: |
          # Clean and copy to versioned directory
          rm -rf "${VERSION}"
          cp -r /tmp/web-bundle "${VERSION}"

          # Clean and copy to latest
          rm -rf latest
          cp -r /tmp/web-bundle latest

      - name: Generate index.html
        run: |
          cat > index.html << 'HEADER'
          <!DOCTYPE html>
          <html lang="ja">
          <head>
            <meta charset="utf-8">
            <meta name="viewport" content="width=device-width, initial-scale=1">
            <title>Sensen</title>
            <style>
              body { font-family: system-ui, sans-serif; max-width: 600px; margin: 40px auto; padding: 0 20px; background: #0a0a0f; color: #e0e0e0; }
              h1 { color: #fff; }
              a { color: #6ea8fe; text-decoration: none; }
              a:hover { text-decoration: underline; }
              .latest { font-size: 1.2em; margin-bottom: 24px; }
              ul { list-style: none; padding: 0; }
              li { padding: 6px 0; }
            </style>
          </head>
          <body>
            <h1>Sensen</h1>
            <p class="latest"><a href="latest/">â–¶ Play Latest</a></p>
            <h2>Versions</h2>
            <ul>
          HEADER

          # List version directories (newest first)
          for dir in $(ls -d v*/ 2>/dev/null | sed 's|/||' | sort -rV); do
            echo "    <li><a href=\"${dir}/\">${dir}</a></li>" >> index.html
          done

          cat >> index.html << 'FOOTER'
            </ul>
          </body>
          </html>
          FOOTER

      - name: Commit and push
        env:
          VERSION: ${{ inputs.version }}
        run: |
          git add -A
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git commit -m "deploy ${VERSION}" || echo "No changes to commit"
          git push origin gh-pages
